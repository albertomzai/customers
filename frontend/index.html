<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Básico - Clientes</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      body { padding-top: 2rem; }
      .modal-header { background-color: #f8f9fa; }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="mb-4">Gestión de Clientes</h1>

        <!-- Botón Añadir Nuevo Cliente -->
        <button id="btnAdd" type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#clientModal">Añadir Nuevo Cliente</button>

        <!-- Campo de Búsqueda -->
        <input id="searchInput" type="text" class="form-control mb-3" placeholder="Buscar por nombre o empresa...">

        <!-- Tabla de Clientes -->
        <table id="clientsTable" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Empresa</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Filas generadas dinámicamente -->
            </tbody>
        </table>

    </div>

    <!-- Modal de Cliente -->
    <div class="modal fade" id="clientModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Añadir Cliente</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="clientForm">
              <input type="hidden" id="clientId" value="">

              <div class="mb-3">
                <label for="nombreCompleto" class="form-label">Nombre Completo</label>
                <input type="text" class="form-control" id="nombreCompleto" required>
              </div>

              <div class="mb-3">
                <label for="empresa" class="form-label">Empresa</label>
                <input type="text" class="form-control" id="empresa">
              </div>

              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required>
              </div>

              <div class="mb-3">
                <label for="telefono" class="form-label">Teléfono</label>
                <input type="text" class="form-control" id="telefono">
              </div>

              <div class="mb-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" required>
                  <option value="Activo">Activo</option>
                  <option value="Inactivo">Inactivo</option>
                  <option value="Potencial">Potencial</option>
                </select>
              </div>

            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="saveClientBtn" type="button" class="btn btn-primary">Guardar Cliente</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript ES6 -->
    <script>

      const apiUrl = '/api/clientes';

      // Obtener referencia a elementos del DOM
      const clientsTableBody = document.querySelector('#clientsTable tbody');
      const searchInput = document.getElementById('searchInput');
      const clientForm = document.getElementById('clientForm');
      const saveClientBtn = document.getElementById('saveClientBtn');
      const modalTitle = document.getElementById('modalTitle');

      // Estado local de clientes cargados
      let clientsData = [];

      // Función para cargar clientes desde la API
      async function loadClients() {
        try {
          const response = await fetch(apiUrl);
          if (!response.ok) throw new Error('Error al obtener clientes');
          clientsData = await response.json();
          renderTable(clientsData);
        } catch (err) {
          console.error(err);
          alert('No se pudieron cargar los clientes.');
        }
      }

      // Renderizar tabla con datos
      function renderTable(data) {
        clientsTableBody.innerHTML = '';
        data.forEach(client => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${client.nombre_completo}</td>
            <td>${client.empresa || ''}</td>
            <td>${client.email}</td>
            <td>${client.status}</td>
            <td>
              <button class="btn btn-warning btn-sm me-2" data-id="${client.id}" onclick="openEditModal(this)">Editar</button>
              <button class="btn btn-danger btn-sm" data-id="${client.id}" onclick="deleteClient(this)">Eliminar</button>
            </td>`;
          clientsTableBody.appendChild(row);
        });
      }

      // Filtrar tabla según búsqueda
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        const filtered = clientsData.filter(c =>
          c.nombre_completo.toLowerCase().includes(query) ||
          (c.empresa && c.empresa.toLowerCase().includes(query))
        );
        renderTable(filtered);
      });

      // Abrir modal para añadir o editar cliente
      function openEditModal(button) {
        const clientId = button.getAttribute('data-id');
        const client = clientsData.find(c => c.id == clientId);

        if (client) {
          modalTitle.textContent = 'Editar Cliente';
          document.getElementById('clientId').value = client.id;
          document.getElementById('nombreCompleto').value = client.nombre_completo;
          document.getElementById('empresa').value = client.empresa || '';
          document.getElementById('email').value = client.email;
          document.getElementById('telefono').value = client.telefono || '';
          document.getElementById('status').value = client.status;
        } else {
          modalTitle.textContent = 'Añadir Cliente';
          clientForm.reset();
          document.getElementById('clientId').value = '';
        }

        const modal = new bootstrap.Modal(document.getElementById('clientModal'));
        modal.show();
      }

      // Función para guardar cliente (crear o actualizar)
      async function saveClient() {
        const id = document.getElementById('clientId').value;
        const payload = {
          nombre_completo: document.getElementById('nombreCompleto').value.trim(),
          empresa: document.getElementById('empresa').value.trim(),
          email: document.getElementById('email').value.trim(),
          telefono: document.getElementById('telefono').value.trim(),
          status: document.getElementById('status').value
        };

        try {
          const method = id ? 'PUT' : 'POST';
          const url = id ? `${apiUrl}/${id}` : apiUrl;
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) throw new Error('Error al guardar cliente');

          await loadClients();
          const modalEl = document.getElementById('clientModal');
          const modalInstance = bootstrap.Modal.getInstance(modalEl);
          modalInstance.hide();
        } catch (err) {
          console.error(err);
          alert('No se pudo guardar el cliente.');
        }
      }

      // Función para eliminar cliente
      async function deleteClient(button) {
        if (!confirm('¿Estás seguro de que deseas eliminar este cliente?')) return;
        const id = button.getAttribute('data-id');

        try {
          const response = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
          if (!response.ok) throw new Error('Error al eliminar cliente');
          await loadClients();
        } catch (err) {
          console.error(err);
          alert('No se pudo eliminar el cliente.');
        }
      }

      // Event listeners
      saveClientBtn.addEventListener('click', saveClient);

      // Cargar clientes al iniciar la página
      document.addEventListener('DOMContentLoaded', loadClients);

    </script>

</body>
</html>